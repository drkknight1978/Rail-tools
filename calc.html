<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltage Drop Calculator - Railway Engineering Utilities</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #e8d5b5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: linear-gradient(145deg, #3a3a3a 0%, #2a2a2a 100%);
            border: 2px solid #6b5539;
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #8b4513 0%, #b8860b 50%, #8b4513 100%);
        }

        h1 {
            font-size: 36px;
            font-weight: bold;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 2px;
            font-variant: small-caps;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #b8945f;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s ease;
        }

        .back-link:hover {
            color: #d4af37;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
            letter-spacing: 0.5px;
        }

        input[type="number"],
        input[type="file"],
        select {
            width: 100%;
            padding: 12px 15px;
            background: #2a2a2a;
            border: 2px solid #6b5539;
            border-radius: 4px;
            color: #e8d5b5;
            font-size: 15px;
            font-family: 'Georgia', 'Times New Roman', serif;
            transition: border-color 0.3s ease;
        }

        input[type="number"]:focus,
        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: #b8860b;
            box-shadow: 0 0 8px rgba(184, 134, 11, 0.3);
        }

        select {
            cursor: pointer;
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="file"] {
            padding: 10px;
            cursor: pointer;
        }

        input[type="file"]::file-selector-button {
            background: linear-gradient(145deg, #8b6f47 0%, #6b5539 100%);
            color: #f5e6d3;
            border: 1px solid #5a4632;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        input[type="file"]::file-selector-button:hover {
            background: linear-gradient(145deg, #b8860b 0%, #8b6f47 100%);
        }

        button {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(145deg, #8b6f47 0%, #6b5539 100%);
            color: #f5e6d3;
            border: 1px solid #5a4632;
            border-radius: 4px;
            font-weight: bold;
            letter-spacing: 1px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-family: 'Georgia', 'Times New Roman', serif;
        }

        button:hover {
            background: linear-gradient(145deg, #b8860b 0%, #8b6f47 100%);
            box-shadow: 0 4px 12px rgba(184, 134, 11, 0.4);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #results {
            margin-top: 30px;
            padding: 20px;
            background: #1a1a1a;
            border: 2px solid #8b6f47;
            border-radius: 4px;
            color: #d4af37;
            font-size: 16px;
            line-height: 1.8;
            display: none;
        }

        #results.active {
            display: block;
        }

        .info-text {
            color: #b8945f;
            font-size: 13px;
            margin-top: 8px;
            font-style: italic;
        }

        .error-text {
            color: #d4534f;
            font-size: 13px;
            margin-top: 8px;
            font-weight: bold;
        }

        .decorative-line {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #8b6f47 50%, transparent 100%);
            margin: 30px 0;
        }

        .rivet {
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #5a5a5a 0%, #2a2a2a 100%);
            border-radius: 50%;
            display: inline-block;
            box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
            margin: 0 15px;
        }

        .rivets-container {
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 28px;
            }

            .container {
                padding: 25px;
            }
        }
    </style>
    <!-- Authentication Script - MUST be loaded first -->
    <script src="auth.js"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Utilities</a>

        <h1>Voltage Drop Calculator</h1>

        <div class="rivets-container">
            <span class="rivet"></span>
            <span class="rivet"></span>
            <span class="rivet"></span>
        </div>

        <div class="form-group">
            <label for="csvFile">Upload Conductor Data (CSV):</label>
            <input type="file" id="csvFile" accept=".csv" onchange="loadConductorData(event)">
            <p class="info-text">CSV format: Conductor Size (mm²),Resistance (Ω/km)</p>
        </div>

        <div class="decorative-line"></div>

        <div class="form-group">
            <label for="conductor">Select Conductor:</label>
            <select id="conductor" disabled>
                <option value="">Please upload conductor data first</option>
            </select>
        </div>

        <div class="form-group">
            <label for="length">Cable Length (km):</label>
            <input type="number" id="length" value="0.1" step="0.01" min="0">
        </div>

        <div class="form-group">
            <label for="load">Power Load (VA):</label>
            <input type="number" id="load" value="825" step="1" min="0">
        </div>

        <div class="form-group">
            <label for="voltage">Supplied Voltage (V):</label>
            <input type="number" id="voltage" value="120" step="1" min="0">
        </div>

        <button onclick="calculateVoltageDropIterative()" id="calculateBtn" disabled>Calculate</button>

        <p id="results"></p>
    </div>

    <script>
        function loadConductorData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const conductorSelect = document.getElementById('conductor');
                const calculateBtn = document.getElementById('calculateBtn');

                // Clear existing options
                conductorSelect.innerHTML = '';

                let validEntries = 0;

                // Parse CSV (skip header row)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const size = parts[0].trim();
                        const resistance = parts[1].trim();

                        if (size && resistance && !isNaN(parseFloat(resistance))) {
                            const option = document.createElement('option');
                            option.value = resistance;
                            option.textContent = size;
                            conductorSelect.appendChild(option);
                            validEntries++;
                        }
                    }
                }

                if (validEntries > 0) {
                    conductorSelect.disabled = false;
                    calculateBtn.disabled = false;
                    document.getElementById('results').className = '';
                    document.getElementById('results').innerHTML = `<span style="color: #90EE90;">✓ Successfully loaded ${validEntries} conductor size(s)</span>`;
                    document.getElementById('results').className = 'active';
                } else {
                    conductorSelect.innerHTML = '<option value="">No valid data found in CSV</option>';
                    conductorSelect.disabled = true;
                    calculateBtn.disabled = true;
                }
            };

            reader.readAsText(file);
        }

        function calculateVoltageDropIterative() {
            const R_cable = parseFloat(document.getElementById("conductor").value);
            const L_cable = parseFloat(document.getElementById("length").value);
            const P_load = parseFloat(document.getElementById("load").value);
            const V_supplied = parseFloat(document.getElementById("voltage").value);

            // Validation
            if (isNaN(R_cable) || isNaN(L_cable) || isNaN(P_load) || isNaN(V_supplied)) {
                document.getElementById('results').className = 'active';
                document.getElementById('results').innerHTML = '<span class="error-text">Please fill in all fields with valid numbers</span>';
                return;
            }

            if (L_cable <= 0 || P_load <= 0 || V_supplied <= 0) {
                document.getElementById('results').className = 'active';
                document.getElementById('results').innerHTML = '<span class="error-text">Values must be greater than zero</span>';
                return;
            }

            let V_load = V_supplied; // Initial assumption: no voltage drop
            let tolerance = 0.01; // Voltage stability tolerance
            let error = 1;
            let iterations = 0;
            let I_load;

            while (error > tolerance) {
                iterations++;
                const R = R_cable * L_cable;
                const V_load_new = V_supplied - (P_load / V_load) * R;
                I_load = P_load / V_load;

                // Update error measure
                error = Math.abs(V_load_new - V_load);
                V_load = V_load_new; // Update load voltage for next iteration

                if (iterations > 100000) { // Prevent infinite loops
                    break;
                }
            }

            const voltageDropPercent = ((V_supplied - V_load) / V_supplied * 100).toFixed(2);

            document.getElementById('results').className = 'active';
            document.getElementById('results').innerHTML = `
                <strong>Calculation Results:</strong><br><br>
                Voltage at Load: <strong>${V_load.toFixed(2)} V</strong><br>
                Current Drawn: <strong>${I_load.toFixed(2)} A</strong><br>
                Voltage Drop: <strong>${(V_supplied - V_load).toFixed(2)} V (${voltageDropPercent}%)</strong><br>
                Iterations: <strong>${iterations}</strong>
            `;
        }
    </script>
</body>
</html>
