<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltage Drop Calculator - Railway Engineering Utilities</title>
    <link rel="stylesheet" href="railway-theme.css">
    <style>
        /* Calculator-specific styles */
        .container {
            max-width: 800px;
        }

        button {
            width: 100%;
            padding: 15px 30px;
            font-size: 16px;
        }

        #results {
            margin-top: 30px;
            padding: 20px;
            background: #1a1a1a;
            border: 2px solid #8b6f47;
            border-radius: 4px;
            color: #d4af37;
            font-size: 16px;
            line-height: 1.8;
            display: none;
        }

        #results.active {
            display: block;
        }
    </style>
    <!-- Authentication Script - MUST be loaded first -->
    <script src="auth.js"></script>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">← Back to Utilities</a>

        <h1>Voltage Drop Calculator</h1>

        <div class="rivets-container">
            <span class="rivet"></span>
            <span class="rivet"></span>
            <span class="rivet"></span>
        </div>

        <div class="form-group">
            <label for="csvFile">Upload Conductor Data (CSV):</label>
            <input type="file" id="csvFile" accept=".csv" onchange="loadConductorData(event)">
            <p class="info-text">CSV format: Conductor Size (mm²),Resistance (Ω/km)</p>
        </div>

        <div class="decorative-line"></div>

        <div class="form-group">
            <label for="conductor">Select Conductor:</label>
            <select id="conductor" disabled>
                <option value="">Please upload conductor data first</option>
            </select>
        </div>

        <div class="form-group">
            <label for="length">Cable Length (km):</label>
            <input type="number" id="length" value="0.1" step="0.01" min="0">
        </div>

        <div class="form-group">
            <label for="load">Power Load (VA):</label>
            <input type="number" id="load" value="825" step="1" min="0">
        </div>

        <div class="form-group">
            <label for="voltage">Supplied Voltage (V):</label>
            <input type="number" id="voltage" value="120" step="1" min="0">
        </div>

        <button onclick="calculateVoltageDropIterative()" id="calculateBtn" disabled>Calculate</button>

        <p id="results"></p>
    </div>

    <script>
        function loadConductorData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                const conductorSelect = document.getElementById('conductor');
                const calculateBtn = document.getElementById('calculateBtn');

                // Clear existing options
                conductorSelect.innerHTML = '';

                let validEntries = 0;

                // Parse CSV (skip header row)
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const size = parts[0].trim();
                        const resistance = parts[1].trim();

                        if (size && resistance && !isNaN(parseFloat(resistance))) {
                            const option = document.createElement('option');
                            option.value = resistance;
                            option.textContent = size;
                            conductorSelect.appendChild(option);
                            validEntries++;
                        }
                    }
                }

                if (validEntries > 0) {
                    conductorSelect.disabled = false;
                    calculateBtn.disabled = false;
                    document.getElementById('results').className = '';
                    document.getElementById('results').innerHTML = `<span style="color: #90EE90;">✓ Successfully loaded ${validEntries} conductor size(s)</span>`;
                    document.getElementById('results').className = 'active';
                } else {
                    conductorSelect.innerHTML = '<option value="">No valid data found in CSV</option>';
                    conductorSelect.disabled = true;
                    calculateBtn.disabled = true;
                }
            };

            reader.readAsText(file);
        }

        function calculateVoltageDropIterative() {
            const R_cable = parseFloat(document.getElementById("conductor").value);
            const L_cable = parseFloat(document.getElementById("length").value);
            const P_load = parseFloat(document.getElementById("load").value);
            const V_supplied = parseFloat(document.getElementById("voltage").value);

            // Validation
            if (isNaN(R_cable) || isNaN(L_cable) || isNaN(P_load) || isNaN(V_supplied)) {
                document.getElementById('results').className = 'active';
                document.getElementById('results').innerHTML = '<span class="error-text">Please fill in all fields with valid numbers</span>';
                return;
            }

            if (L_cable <= 0 || P_load <= 0 || V_supplied <= 0) {
                document.getElementById('results').className = 'active';
                document.getElementById('results').innerHTML = '<span class="error-text">Values must be greater than zero</span>';
                return;
            }

            let V_load = V_supplied; // Initial assumption: no voltage drop
            let tolerance = 0.01; // Voltage stability tolerance
            let error = 1;
            let iterations = 0;
            let I_load;

            while (error > tolerance) {
                iterations++;
                const R = R_cable * L_cable;
                const V_load_new = V_supplied - (P_load / V_load) * R;
                I_load = P_load / V_load;

                // Update error measure
                error = Math.abs(V_load_new - V_load);
                V_load = V_load_new; // Update load voltage for next iteration

                if (iterations > 100000) { // Prevent infinite loops
                    break;
                }
            }

            const voltageDropPercent = ((V_supplied - V_load) / V_supplied * 100).toFixed(2);

            document.getElementById('results').className = 'active';
            document.getElementById('results').innerHTML = `
                <strong>Calculation Results:</strong><br><br>
                Voltage at Load: <strong>${V_load.toFixed(2)} V</strong><br>
                Current Drawn: <strong>${I_load.toFixed(2)} A</strong><br>
                Voltage Drop: <strong>${(V_supplied - V_load).toFixed(2)} V (${voltageDropPercent}%)</strong><br>
                Iterations: <strong>${iterations}</strong>
            `;
        }
    </script>
</body>
</html>
